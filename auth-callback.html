<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>Autenticación — CPG</title>
  <link rel="icon" href="data:,">
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; margin:0; }
    .wrap { min-height: 100dvh; display:grid; place-items:center; padding:24px; }
    .card { width:100%; max-width: 520px; border:1px solid #33415533; border-radius:14px; padding:20px; box-shadow: 0 6px 24px #00000017; background:canvas; }
    .brand { display:flex; gap:12px; align-items:center; margin-bottom:10px; }
    .brand img { width:40px; height:40px; object-fit:contain; }
    h1 { font-size:20px; margin:0; }
    .muted { color:#6b7280; font-size:14px; }
    .ok { color:#059669; }
    .err { color:#dc2626; }
    label { display:block; margin:12px 0 6px; font-size:14px; }
    input[type="password"], input[type="email"], input[type="text"] {
      width:100%; padding:10px 12px; border:1px solid #33415555; border-radius:10px; background:Canvas; color:CanvasText;
    }
    .actions { display:flex; gap:8px; margin-top:14px; flex-wrap:wrap; }
    .btn {
      appearance:none; border:1px solid #33415566; background:#0ea5e9; color:white; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600;
    }
    .btn.secondary { background:transparent; color:CanvasText; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .note { font-size:13px; margin-top:8px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .hidden { display:none; }
    .alert { padding:10px 12px; border-radius:10px; background:#fef3c7; color:#92400e; border:1px solid #f59e0b66; margin:10px 0; }
    .success { padding:10px 12px; border-radius:10px; background:#ecfdf5; color:#065f46; border:1px solid #10b98166; margin:10px 0; }
  </style>

  <!-- Supabase UMD (mismo CDN que usas en index.html) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js" defer></script>

  <script>
    // Toma las mismas credenciales que defines en index.html (o sobrescríbelas aquí si prefieres)
    window.SB_URL = window.SB_URL || "https://ilyospunwucdojrnfgti.supabase.co";
    window.SB_KEY = window.SB_KEY || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlseW9zcHVud3VjZG9qcm5mZ3RpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4Mjk5NzYsImV4cCI6MjA3NDQwNTk3Nn0.gernmW9y1zuvjPCOFo2ie2_2xFIIRKeZWybft7eeoD4";
  </script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="brand">
        <img src="./assets/Logo-cpg.png" alt="Colegio de Psicólogos de Guatemala">
        <div>
          <h1>Autenticación</h1>
          <div class="muted">Colegio de Psicólogos de Guatemala</div>
        </div>
      </div>

      <div id="view-loading">
        <div class="muted">Procesando enlace…</div>
      </div>

      <!-- Vista: Confirmación de correo -->
      <div id="view-signup" class="hidden">
        <div class="success">Tu correo fue verificado correctamente.</div>
        <div class="actions">
          <a class="btn" href="./">Volver al inicio</a>
        </div>
        <div class="note">Si no ves tu sesión iniciada al volver, inicia sesión con tu correo y contraseña.</div>
      </div>

      <!-- Vista: Restablecer contraseña -->
      <div id="view-recovery" class="hidden">
        <div class="alert">Ingresa tu nueva contraseña.</div>
        <form id="resetForm">
          <label>Nueva contraseña</label>
          <input type="password" id="newPass" autocomplete="new-password" minlength="6" required />
          <label>Confirmar nueva contraseña</label>
          <input type="password" id="newPass2" autocomplete="new-password" minlength="6" required />
          <div class="actions">
            <button type="submit" class="btn" id="doReset">Guardar nueva contraseña</button>
            <a class="btn secondary" href="./">Cancelar</a>
          </div>
          <div id="state" class="note muted">—</div>
        </form>
      </div>

      <!-- Vista: Error -->
      <div id="view-error" class="hidden">
        <div class="alert" id="errText">Ocurrió un problema con el enlace.</div>
        <div class="actions">
          <a class="btn" href="./">Volver al inicio</a>
        </div>
        <div class="note">Puedes pedir un nuevo enlace de recuperación desde “¿Olvidaste tu contraseña?” en el inicio de sesión.</div>
      </div>
    </div>
  </div>

  <script>
    (async function main(){
      // Helpers de UI
      const $ = (id)=> document.getElementById(id);
      const show = (id)=> $(id).classList.remove('hidden');
      const hide = (id)=> $(id).classList.add('hidden');

      // Esperar a que cargue el SDK (por si el defer tarda)
      while (!window.supabase || !window.supabase.createClient) {
        await new Promise(r=>setTimeout(r,30));
      }

      // Crear cliente
      const sb = window.supabase.createClient(window.SB_URL, window.SB_KEY);

      // Leer fragmento del URL: Supabase añade datos en el hash (#)
      // Ejemplos: #access_token=...&type=signup  /  #access_token=...&type=recovery
      const hash = new URLSearchParams(location.hash.replace(/^#/, ''));
      const type = (hash.get('type')||'').toLowerCase();
      const errorDesc = hash.get('error_description');

      // Vistas iniciales
      hide('view-signup'); hide('view-recovery'); hide('view-error'); show('view-loading');

      if (errorDesc) {
        // Si la URL ya trae error de Supabase
        $('errText').textContent = errorDesc;
        hide('view-loading'); show('view-error');
        return;
      }

      // Intercambia/establece la sesión en el navegador (si aplica)
      // En links de verificación / recovery basados en token, el cliente puede
      // autoprocesar el hash al llamar a getSession() / onAuthStateChange.
      try { await sb.auth.getSession(); } catch {}

      if (type === 'signup') {
        hide('view-loading'); show('view-signup');
        return;
      }

      if (type === 'recovery') {
        hide('view-loading'); show('view-recovery');

        // Manejador de reset
        $('resetForm').addEventListener('submit', async (e)=>{
          e.preventDefault();
          const p1 = $('newPass').value.trim();
          const p2 = $('newPass2').value.trim();
          $('state').textContent = 'Actualizando contraseña…';

          if (p1.length < 6) { $('state').textContent = 'La contraseña debe tener al menos 6 caracteres.'; return; }
          if (p1 !== p2) { $('state').textContent = 'Las contraseñas no coinciden.'; return; }

          // IMPORTANTE: En este punto debe existir una sesión temporal que viene del enlace de recuperación.
          const { data: sess } = await sb.auth.getSession();
          if (!sess || !sess.session) {
            $('state').innerHTML = 'No hay una sesión de recuperación activa. Abre nuevamente el enlace de tu correo.';
            return;
          }

          const { error } = await sb.auth.updateUser({ password: p1 });
          if (error) {
            $('state').innerHTML = '<span class="err">Error: ' + (error.message || 'no se pudo actualizar') + '</span>';
            return;
          }

          $('state').innerHTML = '<span class="ok">Contraseña actualizada. Puedes volver e iniciar sesión.</span>';
        });

        return;
      }

      // Si llegó sin "type" conocido, mostrar error genérico
      hide('view-loading'); show('view-error');
      $('errText').textContent = 'Enlace inválido o incompleto.';
    })();
  </script>
</body>
</html>
