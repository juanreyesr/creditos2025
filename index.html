<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>Registro de Cr√©ditos Acad√©micos ‚Äî CPG</title>

  <!-- Evita que los modales aparezcan al inicio si el CSS no carga -->
  <style>.modal{display:none}</style>

  <!-- Tu CSS -->
  <link rel="stylesheet" href="./styles.css?v=3" />
  <link rel="icon" href="data:,">

  <!-- Librer√≠as -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js" defer></script>

  <!-- PDF.js para rasterizar la primera p√°gina de PDFs adjuntos -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js" defer></script>

  <!-- Credenciales Supabase -->
  <script>
    window.SB_URL = window.SB_URL || "https://ilyospunwucdojrnfgti.supabase.co";
    window.SB_KEY = window.SB_KEY || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlseW9zcHVud3VjZG9qcm5mZ3RpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4Mjk5NzYsImV4cCI6MjA3NDQwNTk3Nn0.gernmW9y1zuvjPCOFo2ie2_2xFIIRKeZWybft7eeoD4";
  </script>

  <!-- App -->
  <script src="./script.js?v=20" defer></script>
</head>
<body>
  <noscript><div style="background:#fee2e2;color:#991b1b;padding:12px;text-align:center">Esta aplicaci√≥n requiere JavaScript habilitado.</div></noscript>

  <header class="topbar">
    <div class="brand">
      <img src="./assets/Logo-cpg.png" alt="Colegio de Psic√≥logos de Guatemala" class="logo-img" />
      <h1>Registro de Cr√©ditos Acad√©micos</h1>
    </div>
    <!-- Nav oculto hasta que acepten el modal de entrada -->
    <nav class="top-actions" id="mainNav" style="display:none">
      <a class="btn nav-btn" href="https://youtu.be/zitwRCdNgQc" target="_blank" rel="noopener">
        <span class="nav-icon">üìñ</span> Gu√≠a de uso
      </a>
      <a class="btn nav-btn" href="./verificar.html">
        <span class="nav-icon">üîç</span> Verificar constancia
      </a>
      <button class="admin-hidden-button" id="openAdminBtn" title="Abrir panel administrador" type="button">‚óè</button>
      <button class="btn nav-btn primary-nav" id="authBtn" type="button">
        <span class="nav-icon">üîê</span> Iniciar sesi√≥n
      </button>
    </nav>
  </header>

  <main class="container">

    <!-- Secci√≥n: requiere login (visible cuando no est√° autenticado) -->
    <section class="card login-required-card" id="loginRequiredSection" style="display:none">
      <div class="login-required-content">
        <div class="login-required-icon">üîí</div>
        <h2>Inicia sesi√≥n para continuar</h2>
        <p>Para registrar actividades cient√≠fico-acad√©micas y gestionar tus cr√©ditos, necesitas una cuenta activa.</p>
        <div class="login-required-actions">
          <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
            <button class="btn primary large-btn" id="loginRequiredBtn" type="button">Iniciar sesi√≥n</button>
            <button class="btn large-btn" id="signupRequiredBtn" type="button" style="border-color:var(--primary);color:var(--primary)">Crear cuenta</button>
          </div>
          <p class="muted" style="margin-top:12px">Crea tu cuenta en segundos para comenzar a registrar tus cr√©ditos.</p>
        </div>
      </div>
    </section>

    <!-- Secci√≥n: formulario (visible solo cuando est√° autenticado) -->
    <section class="card" id="formSection" style="display:none" aria-labelledby="formTitle">
      <h2 id="formTitle">Nueva actividad cient√≠fico-acad√©mica</h2>
      <p class="help">Regla: <strong>1 cr√©dito = 16 horas</strong> (Art. 16 del reglamento).</p>

      <form id="registroForm" novalidate>
        <div class="grid">
          <label>Nombre completo*
            <input type="text" name="nombre" id="nombre" required maxlength="120" autocomplete="name" />
          </label>

          <label>Celular (GT) *
            <input type="tel" name="telefono" id="telefono" required placeholder="+502 55555555" inputmode="numeric" pattern="(?:\+?502)?\s?\d{8}" autocomplete="tel-national" />
          </label>

          <label>N√∫mero de colegiado* (solo n√∫meros)
            <input type="text" name="colegiadoNumero" id="colegiadoNumero" required maxlength="20" autocomplete="off" inputmode="numeric" pattern="\d*" placeholder="Ej: 0061" />
          </label>

          <label>¬øColegiado activo?*
            <select name="colegiadoActivo" id="colegiadoActivo" required>
              <option value="">‚Äî Seleccione ‚Äî</option>
              <option value="S√≠">S√≠</option>
              <option value="No">No</option>
            </select>
          </label>

          <label>Nombre de la actividad*
            <input type="text" name="actividad" id="actividad" required maxlength="140" />
          </label>

          <label>Instituci√≥n / Organizador*
            <input type="text" name="institucion" id="institucion" required maxlength="140" />
          </label>

          <label>Tipo de actividad*
            <select name="tipo" id="tipo" required>
              <option value="">‚Äî Seleccione ‚Äî</option>
              <option>Te√≥rica</option>
              <option>Pr√°ctica</option>
              <option>Voluntariado profesional</option>
            </select>
          </label>

          <label>Fecha de la actividad*
            <input type="date" name="fecha" id="fecha" required />
          </label>

          <label>Horas registradas* (admite decimales)
            <input type="number" step="0.5" min="0.5" max="600" name="horas" id="horas" required />
          </label>

          <label>Cr√©ditos calculados
            <input type="text" id="creditos" readonly />
          </label>
        </div>

        <label>Observaciones (m√°x. 250 caracteres)
          <textarea id="observaciones" maxlength="250" rows="3" placeholder="Opcional"></textarea>
        </label>

        <!-- CARGA DE ARCHIVOS (OBLIGATORIA) -->
        <div class="uploader" id="uploader" tabindex="0" aria-label="Zona de carga de comprobante (obligatorio)" aria-required="true">
          <input type="file" id="archivo" accept="application/pdf,image/png,image/jpg,image/jpeg" hidden />
          <div class="uploader-inner">
            <p>
              <strong>Arrastre y suelte</strong> su comprobante <strong>(obligatorio)</strong> ‚Äî formatos: PDF, JPG, PNG, JPEG ‚Äî
              o <button type="button" class="linklike" id="browseBtn">examinar</button>
            </p>
            <p class="hint">Tama√±o m√°ximo: 10 MB</p>
            <div id="preview" class="preview" aria-live="polite"></div>
          </div>
        </div>

        <div class="actions">
          <button type="submit" class="btn primary">Registrar y generar constancia</button>
          <button type="reset" class="btn">Limpiar</button>
        </div>
      </form>
    </section>

    <!-- Secci√≥n: historial (visible solo cuando est√° autenticado) -->
    <section class="card" id="histSection" style="display:none" aria-labelledby="histTitle">
      <h2 id="histTitle">Mis registros (sesi√≥n actual)</h2>
      <div class="actions" style="align-items:center;gap:10px;flex-wrap:wrap;margin:8px 0 14px">
        <span class="muted" id="totalCreditosLabel">Total cr√©ditos acumulados: ‚Äî</span>
        <button class="btn" id="downloadConsolidadoBtn" type="button" disabled>Descargar registro unificado</button>
        <button class="btn" id="downloadByYearBtn" type="button" disabled>Registro por a√±o</button>
        <select id="yearSelect" style="display:none;min-width:100px" disabled>
          <option value="">‚Äî A√±o ‚Äî</option>
        </select>
        <button class="btn" id="downloadYearBtn" type="button" style="display:none">Descargar</button>
        <span class="muted" id="consolidadoState">‚Äî</span>
      </div>
      <div class="table-wrap">
        <table id="tablaRegistros" class="table">
          <thead>
            <tr>
              <th>Correlativo</th>
              <th>Fecha</th>
              <th>Actividad</th>
              <th>Horas</th>
              <th>Cr√©ditos</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- MODAL ADMIN -->
  <div class="modal" id="adminModal" aria-hidden="true" role="dialog" aria-labelledby="adminTitle">
    <div class="modal-content" role="document">
      <header class="modal-header">
        <h3 id="adminTitle">Panel de Administrador</h3>
        <button class="iconbtn" id="closeAdmin" type="button">‚úï</button>
      </header>

      <!-- Login administrador local por PIN -->
      <div id="adminAuth">
        <p>Ingrese contrase√±a de administrador (PIN local):</p>
        <input type="password" id="adminPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        <div class="actions">
          <button class="btn primary" id="adminLogin" type="button">Ingresar</button>
        </div>

        <hr />

        <!-- Superadmin por correo/clave -->
        <h4>Entrar como superadmin</h4>
        <p class="muted">Necesita un usuario con validaci√≥n de super administrador registrado en CAEDUC</p>
        <label>Correo
          <input type="email" id="superEmail" placeholder="correo@dominio.com" />
        </label>
        <label>Contrase√±a
          <input type="password" id="superPass" placeholder="********" />
        </label>
        <div class="actions">
          <button class="btn" id="superLogin" type="button">Entrar como superadmin</button>
          <span class="muted" id="adminState">‚Äî</span>
        </div>
      </div>

      <!-- Cuerpo admin -->
      <div id="adminBody" hidden>
        <div class="admin-actions" style="display:flex;flex-wrap:wrap;gap:8px;align-items:center">
          <strong id="adminModeBadge">Modo: Admin local</strong>
          <input type="text" id="adminSearch" placeholder="Buscar correlativo (CPG-AAAAmm-####)" style="flex:1;min-width:240px" />
          <button class="btn" id="adminSearchBtn" type="button">Buscar</button>
          <button class="btn" id="adminClearSearch" type="button">Limpiar</button>

          <label style="display:flex;gap:6px;align-items:center;margin-left:auto">
            <input type="checkbox" id="showDeleted" />
            <span>Mostrar eliminados</span>
          </label>

          <button class="btn" id="exportCSV" type="button">Exportar CSV</button>
          <button class="btn" id="exportXLSX" type="button">Exportar Excel</button>
          <span class="muted" id="exportStatus">‚Äî</span>
        </div>

        <div class="table-wrap">
          <table class="table" id="adminTable">
            <thead>
              <tr>
                <th>Correlativo</th>
                <th>Nombre</th>
                <th>Tel√©fono</th>
                <th>Colegiado</th>
                <th>Activo</th>
                <th>Actividad</th>
                <th>Instituci√≥n</th>
                <th>Tipo</th>
                <th>Fecha</th>
                <th>Horas</th>
                <th>Cr√©ditos</th>
                <th>Archivo</th>
                <th>Hash</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Gesti√≥n de usuarios (solo superadmin) -->
        <div id="userAdminPanel" class="card" style="margin-top:14px" hidden>
          <h4 style="margin:0 0 10px">Activar cuentas de usuarios</h4>
          <p class="muted" style="margin:0 0 10px">
            Si un usuario no recibi√≥ su correo de verificaci√≥n, puedes verificar su estado o activar su cuenta directamente.
          </p>
          <label>Correo del usuario
            <input type="email" id="userAdminEmail" placeholder="usuario@dominio.com" />
          </label>
          <div class="actions" style="gap:8px; flex-wrap:wrap">
            <button class="btn" id="userCheckBtn" type="button">Verificar estado</button>
            <button class="btn warn" id="userActivateBtn" type="button">Activar cuenta sin correo</button>
            <span class="muted" id="userAdminState">‚Äî</span>
          </div>

          <hr style="border-color:var(--border);margin:18px 0" />

          <h4 style="margin:0 0 10px">Gesti√≥n de superadministradores</h4>
          <p class="muted" style="margin:0 0 10px">
            Asigna o quita permisos de superadmin a otros usuarios registrados.
          </p>
          <label>Correo del usuario
            <input type="email" id="adminRoleEmail" placeholder="usuario@dominio.com" />
          </label>
          <div class="actions" style="gap:8px; flex-wrap:wrap">
            <button class="btn primary" id="makeAdminBtn" type="button">Asignar superadmin</button>
            <button class="btn warn" id="removeAdminBtn" type="button">Quitar superadmin</button>
            <span class="muted" id="adminRoleState">‚Äî</span>
          </div>
        </div>

        <p class="muted" id="diagBox">‚Äî</p>
      </div>
    </div>
  </div>

  <!-- MODAL DE AUTENTICACI√ìN -->
  <div class="modal" id="authModal" aria-hidden="true" role="dialog">
    <div class="modal-content modal-auth-content" role="document">
      <header class="modal-header">
        <h3>Acceder</h3>
        <button class="iconbtn" id="closeAuth" type="button">‚úï</button>
      </header>
      <div style="padding:16px 20px">
        <label>Email
          <input type="email" id="authEmail" placeholder="correo@dominio.com" autocomplete="email" autocapitalize="off" />
        </label>
        <label>Contrase√±a
          <input type="password" id="authPass" placeholder="********" autocomplete="current-password" />
        </label>
        <div class="actions" style="margin-top:14px;gap:8px;flex-wrap:wrap">
          <button class="btn primary" id="doLogin" type="button">Entrar</button>
          <button class="btn" id="doSignup" type="button">Crear cuenta</button>
          <button class="btn text-btn" id="doResetPassword" type="button">¬øOlvidaste tu contrase√±a?</button>
        </div>
        <span class="muted" id="authState" style="display:block;margin-top:10px">‚Äî</span>
      </div>
    </div>
  </div>

  <!-- MODAL DE ENTRADA (obligatorio cada vez) -->
  <div class="modal" id="entryModal" aria-hidden="true" role="dialog">
    <div class="modal-content modal-entry-content" role="document">
      <div class="entry-modal-body">
        <div class="entry-logo-wrap">
          <img src="./assets/Logo-cpg.png" alt="CPG" class="entry-logo" />
        </div>
        <h2 class="entry-title">Bienvenido al Registro de Cr√©ditos Acad√©micos</h2>
        <p class="entry-subtitle">Colegio de Psic√≥logos de Guatemala</p>

        <div class="entry-info">
          <p><strong>Para registrar constancias o gestionar las que ya tienes</strong>, debes crear una cuenta o iniciar sesi√≥n con tu usuario existente.</p>
          <p>Al continuar, aceptas que tus datos se almacenar√°n para generar correlativos y emitir constancias conforme al Art. 16 (1 cr√©dito = 16 horas).</p>
          <p class="entry-ethics">De acuerdo con el principio 3.1.1 del c√≥digo de √©tica: Los psic√≥logos representan digna y adecuadamente su profesi√≥n. Evidencian una conducta honesta, proba, no participan en actividades il√≠citas, enga√±o, fraude o tergiversaci√≥n de informaci√≥n, discurso y/o hechos.</p>
        </div>

        <button class="btn primary large-btn entry-accept-btn" id="entryAccept" type="button">Acepto y continuar</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true"></div>

  <footer class="foot">
    <small>¬© 2025 ‚Äî Colegio de Psic√≥logos de Guatemala, junta directiva 2025 - 2027 con aval de CAEDUC.</small>
  </footer>
</body>
</html>
